

<div class="h-screen w-screen flex bg-[#f7f9fa] dark:bg-slate-950 font-sans text-slate-700 dark:text-slate-200 overflow-hidden transition-colors duration-300">
  
  <!-- NEW SIDEBAR COMPONENT -->
  <app-sidebar 
    (openSearch)="openSearch()"
    (openCertificates)="viewCertificates()"
    (openSources)="toggleSourceManager()"
    (openAbout)="openModal('about')"
    (openTutorial)="openModal('tutorial')"
    (openImpressum)="openModal('impressum')"
    (openLanguage)="openModal('language')"
    (signIn)="signIn()"
    (signOut)="signOut()"
  ></app-sidebar>

  <!-- Mobile Header (Hidden on Desktop) -->
  <header class="md:hidden fixed top-0 left-0 right-0 h-16 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 z-50 flex items-center justify-between px-4 shadow-sm transition-transform duration-300">
      <div class="flex items-center gap-2">
         <span class="text-2xl">üå≥</span>
         <span class="font-black text-slate-800 dark:text-white tracking-tight">ARBOR</span>
      </div>
      
      <div class="flex items-center gap-2">
        <button (click)="openSearch()" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 active:scale-95 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
               <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
             </svg>
        </button>
        
        <button (click)="dataService.setViewMode('certificates'); isProgressOpen = false" class="w-9 h-9 flex items-center justify-center rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 active:scale-95 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
               <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0V5.625a2.25 2.25 0 00-2.25-2.25h-1.5a2.25 2.25 0 00-2.25 2.25v7.875" />
            </svg>
        </button>

         <button (click)="toggleSourceManager()" class="w-9 h-9 flex items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 active:scale-95 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6M9 11.25h6M9 15.75h6" /></svg>
        </button>

        <button (click)="dataService.toggleTheme()" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-xl active:scale-95 transition-transform">
           @if (dataService.theme() === 'light') { üåô } @else { ‚òÄÔ∏è }
        </button>
        
        <button (click)="openModal('tutorial')" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold active:scale-95 transition-transform">?</button>
      </div>
  </header>

  <main class="flex-1 relative flex flex-col h-full bg-[#f7f9fa] dark:bg-slate-950 pt-16 md:pt-0">
    
    <!-- Top Bar with Breadcrumbs & Progress Stats -->
    <header class="absolute top-16 md:top-0 left-0 right-0 h-16 md:h-20 flex items-center justify-between px-4 md:px-6 z-20 pointer-events-none gap-4">
        
        <div class="pointer-events-auto flex-1 min-w-0 overflow-hidden relative">
            <div class="flex items-center gap-2">
                <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border border-slate-200 dark:border-slate-700 p-2 rounded-full hidden lg:block">
                    <div class="w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-400 flex items-center justify-center text-xs font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6M9 11.25h6M9 15.75h6" /></svg>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-bold text-slate-400 dark:text-slate-500 truncate">EXPLORANDO</p>
                    <p class="text-sm font-bold text-slate-600 dark:text-slate-300 truncate">{{ dataService.activeSource()?.name }}</p>
                </div>
            </div>
             <app-breadcrumbs></app-breadcrumbs>
        </div>

        <div class="hidden lg:flex items-center gap-3 pointer-events-auto relative flex-shrink-0">
             <button (click)="toggleProgress()" class="flex items-center gap-2 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-full shadow-sm hover:border-green-400 dark:hover:border-green-600 transition-colors">
                <span class="text-yellow-500 text-lg">üèÖ</span>
                <span class="font-bold text-slate-600 dark:text-slate-300 text-sm">{{ dataService.completedNodes().size }}</span>
             </button>

             @if (isProgressOpen) {
                <div class="absolute top-full right-0 mt-2 w-80 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl p-6 flex flex-col items-center z-40 animate-in fade-in slide-in-from-top-2 duration-200">
                    <h3 class="text-lg font-black text-slate-800 dark:text-white mb-4">{{ dataService.ui().progressTitle }}</h3>
                    
                    <div class="relative w-32 h-32">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                          <circle class="text-slate-200 dark:text-slate-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                          <circle
                            class="text-green-500"
                            stroke-width="10"
                            [attr.stroke-dasharray]="282.74"
                            [attr.stroke-dashoffset]="282.74 * (1 - (dataService.overallProgressPercentage() / 100))"
                            stroke-linecap="round"
                            stroke="currentColor"
                            fill="transparent"
                            r="45"
                            cx="50"
                            cy="50"
                            style="transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease-out;"
                          />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-3xl font-black text-slate-800 dark:text-white">{{ dataService.overallProgressPercentage() }}%</span>
                            <span class="text-xs font-bold text-slate-500 dark:text-slate-400">{{ dataService.ui().progressOverall }}</span>
                        </div>
                    </div>

                    <div class="w-full grid grid-cols-2 gap-4 text-center my-6">
                        <div>
                            <p class="text-2xl font-bold text-sky-600 dark:text-sky-400">{{ dataService.completedNodes().size }}</p>
                            <p class="text-xs font-medium text-slate-500">{{ dataService.ui().progressLessons }}</p>
                        </div>
                         <div>
                            <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ dataService.completedModulesCount() }}</p>
                            <p class="text-xs font-medium text-slate-500">{{ dataService.ui().progressModules }}</p>
                        </div>
                    </div>

                    <button (click)="viewCertificates()" class="w-full py-3 bg-yellow-500 hover:bg-yellow-400 text-white font-bold rounded-xl shadow-lg shadow-yellow-500/30 transition-all active:scale-95 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0V5.625a2.25 2.25 0 00-2.25-2.25h-1.5a2.25 2.25 0 00-2.25 2.25v7.875" /></svg>
                        {{ dataService.ui().progressViewCerts }}
                    </button>
                </div>
             }
        </div>
    </header>

    <div class="w-full h-full absolute inset-0 z-10">
        <app-graph-visualizer></app-graph-visualizer>
    </div>
    
    @if(dataService.activeSource(); as source) {
        @if (!source.isDefault) {
             <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 bg-yellow-100 dark:bg-yellow-900/50 border border-yellow-300 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200 text-xs font-bold px-4 py-2 rounded-full shadow-lg animate-in fade-in slide-in-from-bottom-2 duration-300">
                <span class="mr-1">‚ö†Ô∏è</span> {{ dataService.ui().sourceWarning }}
             </div>
        }
    }

  </main>

  <app-content-panel></app-content-panel>
  <app-lesson-preview></app-lesson-preview>
  
  @if (dataService.viewMode() === 'certificates') {
      <app-certificates-gallery></app-certificates-gallery>
  }

  <app-source-manager [isOpen]="isSourceManagerOpen" (closeModal)="toggleSourceManager()"></app-source-manager>

  <!-- NEW INFO MODALS (Handles Tutorial, About, etc) -->
  @if (activeModal) {
      <app-info-modals [type]="activeModal" [isOpen]="true" (close)="closeModal()"></app-info-modals>
  }

  @if (isSearchOpen) {
    <div class="fixed inset-0 z-[70] flex items-start justify-center pt-[15vh] md:pt-[20vh] bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" (click)="closeSearch()">
        <div class="w-full max-w-2xl bg-white dark:bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-700 flex flex-col max-h-[60vh]" (click)="$event.stopPropagation()">
            
            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 text-slate-400">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input 
                    id="searchInput"
                    type="text" 
                    [(ngModel)]="searchQuery" 
                    (ngModelChange)="onSearchInput()"
                    [placeholder]="dataService.ui().searchPlaceholder"
                    class="w-full bg-transparent text-lg md:text-xl font-bold text-slate-700 dark:text-white outline-none placeholder:text-slate-300 dark:placeholder:text-slate-600"
                    autocomplete="off"
                >
                <button (click)="closeSearch()" class="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs font-bold text-slate-500">ESC</button>
            </div>

            <div class="overflow-y-auto p-2">
                @if (searchResults.length > 0) {
                    @for (result of searchResults; track result.id) {
                        <button (click)="navigateToResult(result)" class="w-full text-left p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors group flex items-center justify-between border-b border-slate-50 dark:border-slate-800/50 last:border-0">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-sky-50 dark:bg-sky-900/20 text-sky-600 dark:text-sky-400 flex items-center justify-center text-xl">
                                    {{ result.icon || 'üìÑ' }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-700 dark:text-slate-200 group-hover:text-sky-600 transition-colors">{{ result.name }}</h3>
                                    @if(result.description) {
                                        <p class="text-xs text-slate-400 line-clamp-1">{{ result.description }}</p>
                                    }
                                </div>
                            </div>
                            <span class="text-xs font-bold text-slate-300 group-hover:text-slate-400 uppercase tracking-wider hidden sm:block">
                                {{ result.type === 'leaf' ? dataService.ui().leafLabel : 'Module' }}
                            </span>
                        </button>
                    }
                } @else if (searchQuery.length > 0) {
                    <div class="p-8 text-center text-slate-400">
                        <p>{{ dataService.ui().noResults }}</p>
                    </div>
                }
            </div>
        </div>
    </div>
  }

</div>