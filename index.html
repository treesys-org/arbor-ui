<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Arbor: Visual Knowledge Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  
  <!-- 
    GDPR / PRIVACY ARCHITECTURE:
    No external scripts (CDNs) are loaded by default.
    The 'bootloader' script below handles consent logic before injecting dependencies.
  -->

  <style>
    /* CRITICAL SYSTEM STYLES (Inline to avoid external requests) */
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #0f172a; font-family: system-ui, -apple-system, sans-serif; color: #e2e8f0; }
    
    /* Gatekeeper UI */
    #gatekeeper { display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; inset: 0; z-index: 9999; background: #0f172a; padding: 20px; text-align: center; transition: opacity 0.5s; }
    .gate-card { max-width: 480px; background: #1e293b; border: 1px solid #334155; border-radius: 24px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    .gate-icon { font-size: 64px; margin-bottom: 24px; display: block; }
    .gate-title { font-size: 24px; font-weight: 900; margin: 0 0 16px 0; color: #fff; letter-spacing: -0.02em; }
    .gate-text { font-size: 15px; line-height: 1.6; color: #94a3b8; margin-bottom: 32px; }
    .gate-btn { background: #fff; color: #0f172a; border: none; padding: 16px 32px; font-size: 16px; font-weight: 800; border-radius: 12px; cursor: pointer; transition: transform 0.1s, opacity 0.2s; width: 100%; text-transform: uppercase; letter-spacing: 0.05em; }
    .gate-btn:hover { opacity: 0.9; transform: scale(1.02); }
    .gate-btn:active { transform: scale(0.98); }
    .gate-links { margin-top: 24px; font-size: 12px; color: #475569; }
    .gate-links a { color: #64748b; text-decoration: underline; }
    
    /* Loading Spinner for Boot phase */
    #boot-loader { display: none; position: fixed; inset: 0; z-index: 9000; background: #0f172a; align-items: center; justify-content: center; flex-direction: column; }
    .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: #22c55e; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
    .boot-text { font-family: monospace; font-size: 12px; color: #22c55e; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Hide App until loaded */
    #app { display: none; }
    
    /* Utility */
    .hidden { display: none !important; }
  </style>

  <!-- POLYFILLS -->
  <script>
    window.process = { env: { NODE_ENV: 'production' } };
  </script>
</head>
<body>

  <!-- 1. THE GATEKEEPER (Privacy & Resources Consent) -->
  <div id="gatekeeper">
    <div class="gate-card">
        <span class="gate-icon">ðŸŒ³</span>
        <h1 class="gate-title">Welcome to Arbor</h1>
        <div class="gate-text">
            <p><strong>Consent & Initialization:</strong></p>
            <p>Arbor is a "Zero-Build" browser application. To function, it requires your permission to load necessary styles and visualization engines.</p>
            <p style="font-size: 13px; background: #334155; padding: 12px; border-radius: 8px; margin-top:16px;">
                By clicking "Enter", you agree to the <strong>Privacy Policy</strong> (Local Storage usage) and consent to loading: <br>
                1. <strong>TailwindCSS</strong> (UI Styling) <br>
                2. <strong>D3.js</strong> (Graph Visualization)
            </p>
        </div>
        <button id="btn-accept" class="gate-btn">Accept & Enter</button>
        <div class="gate-links">
            Your progress is saved locally on this device.
        </div>
    </div>
  </div>

  <!-- 2. BOOT LOADER (Visual feedback during injection) -->
  <div id="boot-loader">
      <div class="spinner"></div>
      <div class="boot-text" id="boot-status">INITIALIZING...</div>
  </div>

  <!-- 3. THE APP CONTAINER -->
  <div id="app" class="h-full w-full flex relative overflow-hidden bg-[#f7f9fa] dark:bg-slate-950 text-slate-700 dark:text-slate-200 transition-colors duration-300">
     <!-- Components will be injected here by main.js -->
     <arbor-sidebar></arbor-sidebar>
     <main class="flex-1 relative flex flex-col h-full pt-16 md:pt-0">
        <div class="w-full h-full absolute inset-0 z-10">
            <arbor-graph></arbor-graph>
        </div>
     </main>
     <arbor-content></arbor-content>
     <arbor-construction-panel></arbor-construction-panel>
     <arbor-modals></arbor-modals>
     <arbor-editor></arbor-editor>
     <arbor-sage></arbor-sage>
     <arbor-version-widget></arbor-version-widget>
     <arbor-progress-widget></arbor-progress-widget>
  </div>

  <!-- 4. BOOTLOADER SCRIPT -->
  <script>
    (function() {
        const STORAGE_KEY = 'arbor-consent-v1';
        const gatekeeper = document.getElementById('gatekeeper');
        const bootLoader = document.getElementById('boot-loader');
        const bootStatus = document.getElementById('boot-status');
        const app = document.getElementById('app');
        const btnAccept = document.getElementById('btn-accept');

        // DEPENDENCIES: ONLY THE ESSENTIALS
        const SCRIPTS = [
            { src: "https://d3js.org/d3.v7.min.js", name: "D3 Visualization" },
            { src: "https://cdn.tailwindcss.com", name: "UI Framework" }
        ];

        function log(msg) {
            console.log(`[Arbor Boot] ${msg}`);
            if(bootStatus) bootStatus.innerText = msg;
        }

        async function injectDependencies() {
            gatekeeper.classList.add('hidden');
            bootLoader.style.display = 'flex';

            try {
                // 1. Inject CSS/Libs
                for (const lib of SCRIPTS) {
                    log(`Loading ${lib.name}...`);
                    await new Promise((resolve, reject) => {
                        const s = document.createElement('script');
                        s.src = lib.src;
                        s.onload = resolve;
                        s.onerror = reject;
                        document.head.appendChild(s);
                    });
                }

                // 2. Configure Tailwind
                log("Configuring Styles...");
                if (window.tailwind) {
                    window.tailwind.config = {
                        darkMode: 'class',
                        theme: {
                            extend: {
                                fontFamily: {
                                    sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                                    mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
                                }
                            }
                        }
                    };
                }

                // 3. Launch App
                log("Launching Arbor...");
                const mainScript = document.createElement('script');
                mainScript.type = 'module';
                mainScript.src = './src/main.js';
                mainScript.onload = () => {
                    bootLoader.style.display = 'none';
                    app.style.display = 'flex';
                };
                document.body.appendChild(mainScript);

            } catch (e) {
                log("BOOT ERROR: " + e.message);
                alert("Failed to load resources. Check internet connection.");
            }
        }

        // INIT LOGIC
        const hasConsent = localStorage.getItem(STORAGE_KEY);

        if (hasConsent) {
            injectDependencies();
        } else {
            // Show Gatekeeper (already visible by CSS, but ensure listeners)
            btnAccept.onclick = () => {
                localStorage.setItem(STORAGE_KEY, 'true');
                injectDependencies();
            };
        }
    })();
  </script>
</body>
</html>