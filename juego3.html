<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbor Academy: The Classroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #202020;
            color: white;
            font-family: 'VT323', monospace;
            overflow: hidden;
            user-select: none;
        }
        
        #game-container {
            position: relative;
            width: 1024px;
            height: 768px;
            margin: 20px auto;
            background-color: #353535;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid #555;
            image-rendering: pixelated;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI OVERLAYS */
        .pixel-panel {
            background: #fff;
            border: 4px solid #000;
            box-shadow: 4px 4px 0px #000;
            color: #000;
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .dialogue-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 180px;
            padding: 20px;
            display: none;
            z-index: 10;
        }

        .dialogue-name {
            position: absolute;
            top: -20px;
            left: 20px;
            background: #000;
            color: #fff;
            padding: 5px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            border: 2px solid #fff;
        }

        .blackboard-text {
            font-family: 'cursive'; 
            color: rgba(255,255,255,0.9);
        }

        /* Input Area */
        #input-area {
            position: absolute;
            bottom: 25px;
            left: 30px;
            right: 30px;
            display: none;
            gap: 10px;
            z-index: 20;
        }

        input[type="text"] {
            flex: 1;
            background: #000;
            color: #0f0;
            border: 2px solid #fff;
            padding: 10px;
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            outline: none;
        }

        /* Config Modal */
        #config-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <!-- CONFIG / START SCREEN -->
    <div id="config-modal">
        <div class="pixel-panel p-8 max-w-lg w-full text-center">
            <h1 class="text-4xl mb-4 font-bold font-['Press_Start_2P'] text-blue-700">ARBOR ACADEMY</h1>
            <p class="mb-4 text-xl">Simulador de Aula con IA Local</p>
            
            <div class="text-left bg-gray-100 p-4 mb-6 border-2 border-dashed border-gray-400 text-sm">
                <p class="font-bold text-red-600 mb-2">‚ö†Ô∏è REQUISITO T√âCNICO (CORS)</p>
                <p>Para que el navegador hable con Ollama, debes iniciar Ollama as√≠ en tu terminal:</p>
                <code class="block bg-black text-green-400 p-2 mt-2 rounded">OLLAMA_ORIGINS="*" ollama serve</code>
            </div>

            <div class="mb-4 text-left">
                <label class="block font-bold">Modelo Ollama:</label>
                <input id="model-name" type="text" value="llama3.1:latest" class="w-full border-2 border-black p-2 mt-1">
            </div>

            <div class="mb-6 text-left">
                <label class="block font-bold">Seleccionar Curso:</label>
                <select id="course-preset" class="w-full border-2 border-black p-2 mt-1 mb-2 bg-white" onchange="document.getElementById('repo-path').value = this.value">
                    <option value="es/01-computacion/02-sistemas-y-arquitectura/01-sistemas-operativos/01-linux/01-fundamentos-para-principiantes">üêß Linux Fundamentos</option>
                    <option value="es/06-idiomas-y-linguistica/01-ingles/01-nivel-a1">üá¨üáß Ingl√©s Nivel A1</option>
                </select>

                <label class="block font-bold text-xs text-gray-500">Ruta Manual (Avanzado):</label>
                <input id="repo-path" type="text" value="es/01-computacion/02-sistemas-y-arquitectura/01-sistemas-operativos/01-linux/01-fundamentos-para-principiantes" class="w-full border-2 border-black p-2 mt-1 text-xs text-gray-600">
            </div>

            <button onclick="Game.init()" class="bg-blue-600 text-white w-full py-4 font-bold hover:bg-blue-500 border-4 border-black shadow-[4px_4px_0px_#000] active:translate-y-1 active:shadow-none transition-all">
                ENTRAR A CLASE
            </button>
            <p id="status-msg" class="mt-4 text-sm text-gray-500">Esperando conexi√≥n...</p>
        </div>
    </div>

    <!-- MAIN GAME AREA -->
    <div id="game-container">
        <canvas id="world"></canvas>
        
        <!-- UI -->
        <div id="dialogue-box" class="dialogue-box pixel-panel">
            <div id="dialogue-name" class="dialogue-name">PROFESOR ARBOR</div>
            <div id="dialogue-text">...</div>
            <div class="absolute bottom-2 right-4 text-xs text-gray-400 animate-pulse">‚ñº SPACE para continuar</div>
        </div>

        <div id="input-area">
            <input type="text" id="player-input" placeholder="Escribe tu respuesta..." autocomplete="off">
            <button onclick="Game.submitAnswer()" class="bg-green-600 text-white px-6 border-2 border-white hover:bg-green-500 font-bold">RESPONDER</button>
        </div>
    </div>

<script>
/**
 * ARBOR ACADEMY - SINGLE FILE GAME
 * Connects to Arbor GitHub JSON + Local Ollama
 */

// --- CONFIGURATION ---
const API = {
    arborBase: 'https://raw.githubusercontent.com/treesys-org/arbor-knowledge/main/data',
    ollamaBase: 'http://localhost:11434/api/chat',
    model: 'llama3.1:latest',
    targetPath: '' 
};

// --- OLLAMA CLIENT ---
const AI = {
    async chat(messages, systemContext = "") {
        const payload = {
            model: API.model,
            messages: [
                { role: "system", content: systemContext },
                ...messages
            ],
            stream: false,
            options: { temperature: 0.7 }
        };

        try {
            const response = await fetch(API.ollamaBase, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("Ollama connection failed");
            const data = await response.json();
            return data.message.content;
        } catch (e) {
            console.error(e);
            return null;
        }
    },

    // Extracts simple JSON from potentially messy LLM output
    extractJSON(text) {
        try {
            // Find first { and last }
            const start = text.indexOf('{');
            const end = text.lastIndexOf('}');
            if (start === -1 || end === -1) return null;
            return JSON.parse(text.substring(start, end + 1));
        } catch (e) { return null; }
    }
};

// --- ARBOR CONTENT CLIENT ---
const Content = {
    lessons: [],
    
    async load(path) {
        this.lessons = [];
        await this.traverse(path);
        console.log(`Loaded ${this.lessons.length} lessons.`);
        return this.lessons.length > 0;
    },

    // Recursive traversal to handle nested folders/modules
    async traverse(nodePath) {
        const url = `${API.arborBase}/nodes/${nodePath}.json`;
        try {
            const res = await fetch(url);
            if (!res.ok) return;
            const nodes = await res.json();
            
            // Process current level
            const promises = nodes.map(async (node) => {
                if (node.type === 'leaf') {
                    this.lessons.push(node);
                } else if (node.type === 'branch' && node.apiPath) {
                    await this.traverse(node.apiPath);
                }
            });
            
            await Promise.all(promises);
        } catch (e) {
            console.warn("Skipping path due to error:", nodePath);
        }
    },

    async fetchLessonText(contentPath) {
        const url = `${API.arborBase}/content/${contentPath}`;
        const res = await fetch(url);
        const data = await res.json();
        // Clean HTML tags for the AI
        return data.content.replace(/<[^>]*>?/gm, '');
    }
};

// --- GAME ENGINE ---
const Game = {
    canvas: null,
    ctx: null,
    state: 'MENU', // MENU, LECTURE, INTERACTION, INPUT
    currentLesson: null,
    lessonText: '',
    
    // Blackboard State
    boardTopic: "Cargando...",
    boardItems: [], // { text: string, done: boolean }

    // Actors
    prof: { x: 512, y: 150, frame: 0, text: "Bienvenido a clase." },
    students: [
        { x: 200, y: 400, color: '#f00', name: 'Lola' },
        { x: 512, y: 400, color: '#0f0', name: 'Timmy' },
        { x: 824, y: 400, color: '#00f', name: 'Nerd' }
    ],
    
    init: async function() {
        API.model = document.getElementById('model-name').value;
        API.targetPath = document.getElementById('repo-path').value;
        const msg = document.getElementById('status-msg');

        msg.innerText = "Conectando con Ollama...";
        const pong = await AI.chat([{role: 'user', content: 'hi'}]);
        if (!pong) {
            msg.innerText = "‚ùå Error: No se detecta Ollama. Revisa CORS.";
            msg.style.color = "red";
            return;
        }

        msg.innerText = "Explorando repositorio Arbor...";
        const loaded = await Content.load(API.targetPath);
        if (!loaded) {
            msg.innerText = "‚ùå Error: No se encontraron lecciones en esta ruta (¬øcarpeta vac√≠a?).";
            return;
        }

        // Start Game
        document.getElementById('config-modal').style.display = 'none';
        this.canvas = document.getElementById('world');
        this.canvas.width = 1024;
        this.canvas.height = 768;
        this.ctx = this.canvas.getContext('2d');
        
        this.startLoop();
        this.startNewClass();
    },

    async startNewClass() {
        // Pick random lesson
        this.currentLesson = Content.lessons[Math.floor(Math.random() * Content.lessons.length)];
        this.lessonText = await Content.fetchLessonText(this.currentLesson.contentPath);
        this.boardTopic = "Escribiendo...";
        this.boardItems = [];
        
        // Phase 1: Professor Intro & Blackboard Setup
        this.state = 'LECTURE';
        this.uiShowDialog("PROFESOR ARBOR", `Tema de hoy: ${this.currentLesson.name}. (Preparando explicaci√≥n...)`);
        
        // Prompt for Structured Content (Topic + 3 Concepts + LECTURE TEXT)
        const planJSON = await AI.chat([
            { role: "user", content: `Texto de la lecci√≥n: "${this.lessonText.substring(0, 3000)}". 
            TAREA: 
            1. Extrae T√≠tulo y 3 conceptos breves para la pizarra.
            2. Genera una "lecture" (explicaci√≥n del profesor) clara, directa y educativa de m√°ximo 50 palabras para explicar el tema a los alumnos antes de que pregunten.
            
            FORMATO JSON: {"topic": "T√≠tulo Corto", "concepts": ["Concepto 1", "Concepto 2", "Concepto 3"], "lecture": "Explicaci√≥n del profesor aqu√≠..."}` }
        ], "Eres un profesor experto que explica claramente. Responde SOLO JSON.");
        
        const plan = AI.extractJSON(planJSON);
        
        if (plan) {
            this.boardTopic = plan.topic || this.currentLesson.name;
            this.boardItems = (plan.concepts || []).map(c => ({ text: c, done: false }));
            // Mostrar la explicaci√≥n del profesor
            this.uiShowDialog("PROFESOR ARBOR", plan.lecture || "Atentos a la explicaci√≥n...");
        } else {
            this.boardTopic = this.currentLesson.name;
            this.boardItems = [{text: "Conceptos Generales", done: false}, {text: "Pr√°ctica", done: false}];
            this.uiShowDialog("PROFESOR ARBOR", "Vamos a analizar este texto. Leed conmigo...");
        }
        
        // Wait for player to press space to continue to interaction
        window.addEventListener('keydown', this.handleInput);
    },

    async triggerInteraction() {
        window.removeEventListener('keydown', this.handleInput);
        this.state = 'INTERACTION';
        
        // Pick a student
        const student = this.students[Math.floor(Math.random() * this.students.length)];
        this.uiShowDialog(student.name, "Profe, una duda sobre lo que explic√≥...");

        const questionJSON = await AI.chat([
            { role: "user", content: `Basado en este texto: "${this.lessonText.substring(0, 1500)}". Genera una pregunta curiosa que un estudiante har√≠a sobre estos puntos: ${JSON.stringify(this.boardItems)}. Output JSON: {"question": "texto"}` }
        ], "Eres un estudiante curioso. Responde solo en JSON.");
        
        const parsed = AI.extractJSON(questionJSON);
        const question = parsed ? parsed.question : "¬øPuedes explicar eso otra vez?";

        this.uiShowDialog(student.name, question);
        
        // Enable input
        setTimeout(() => {
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('player-input').focus();
            this.state = 'INPUT';
        }, 1000);
        
        this.currentQuestion = question;
    },

    async submitAnswer() {
        const input = document.getElementById('player-input');
        const answer = input.value;
        if (!answer.trim()) return;

        input.value = '';
        document.getElementById('input-area').style.display = 'none';
        
        this.uiShowDialog("PROFESOR ARBOR", "Evaluando respuesta...");

        const evalJSON = await AI.chat([
            { role: "user", content: `Contexto: ${this.lessonText.substring(0,1000)}. Pregunta del alumno: "${this.currentQuestion}". Respuesta del usuario (Profesor auxiliar): "${answer}". Eval√∫a si la explicaci√≥n es correcta pedag√≥gicamente. JSON: {"correct": boolean, "comment": "feedback corto"}` }
        ], "Eres un profesor senior evaluando a un auxiliar. Responde solo JSON.");

        const result = AI.extractJSON(evalJSON);
        
        if (result) {
            this.uiShowDialog("PROFESOR ARBOR", (result.correct ? "¬°MUY BIEN! " : "Mmm... ") + result.comment);
            
            if (result.correct) {
                // Mark progress on Blackboard
                const nextItem = this.boardItems.find(i => !i.done);
                if (nextItem) nextItem.done = true;
                
                // If all done, finish class
                if (this.boardItems.every(i => i.done)) {
                     setTimeout(() => this.uiShowDialog("PROFESOR ARBOR", "¬°Clase terminada! Borrando pizarra..."), 3000);
                     setTimeout(() => this.startNewClass(), 5000);
                     return;
                }
            }

            // Loop back to new interaction (Next student question)
            setTimeout(() => {
                this.uiShowDialog("PROFESOR ARBOR", "Siguiente pregunta... (Espacio)");
                window.addEventListener('keydown', this.handleInput); // Re-enable space to continue
            }, 3000);
        } else {
            this.uiShowDialog("PROFESOR ARBOR", "No te entend√≠. Intenta de nuevo.");
            this.startNewClass();
        }
        
        this.state = 'LECTURE'; 
    },

    handleInput: (e) => {
        if (e.code === 'Space' && Game.state === 'LECTURE') {
            Game.triggerInteraction();
        } else if (e.code === 'Enter' && Game.state === 'INPUT') {
            Game.submitAnswer();
        }
    },

    uiShowDialog(name, text) {
        const box = document.getElementById('dialogue-box');
        const nameEl = document.getElementById('dialogue-name');
        const textEl = document.getElementById('dialogue-text');
        
        box.style.display = 'block';
        nameEl.innerText = name;
        
        // Typewriter effect
        textEl.innerHTML = '';
        let i = 0;
        const speed = 20; 
        
        if (this.typeInterval) clearInterval(this.typeInterval);
        
        this.typeInterval = setInterval(() => {
            textEl.textContent += text.charAt(i);
            i++;
            if (i > text.length) clearInterval(this.typeInterval);
        }, speed);
    },

    // --- RENDER LOOP ---
    startLoop() {
        const loop = () => {
            this.draw();
            requestAnimationFrame(loop);
        };
        loop();
    },

    draw() {
        const ctx = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;

        // 1. Background (Classroom Floor & Wall)
        ctx.fillStyle = '#5d4037'; // Floor wood
        ctx.fillRect(0, 300, w, h-300);
        
        ctx.fillStyle = '#e0e0e0'; // Wall
        ctx.fillRect(0, 0, w, 300);
        
        // 2. Blackboard
        ctx.fillStyle = '#2e3b28';
        ctx.fillRect(150, 20, w-300, 200);
        ctx.strokeStyle = '#8d6e63';
        ctx.lineWidth = 10;
        ctx.strokeRect(150, 20, w-300, 200);
        
        // Chalk Text (Dynamic Syllabus)
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.font = '24px cursive';
        ctx.textAlign = 'center';
        
        // Title
        ctx.fillText(this.boardTopic.toUpperCase(), w/2, 60);
        
        // Checklist Items
        ctx.textAlign = 'left';
        ctx.font = '20px cursive';
        
        let startY = 100;
        this.boardItems.forEach((item, index) => {
            // Draw Checkbox
            ctx.fillStyle = item.done ? '#4ade80' : 'rgba(255,255,255,0.5)';
            const mark = item.done ? "[ ‚úì ]" : "[   ]";
            ctx.fillText(mark, 200, startY);
            
            // Draw Text (Strikethrough if done? Maybe just white)
            ctx.fillStyle = 'white';
            ctx.fillText(item.text, 280, startY);
            
            startY += 40;
        });

        // 3. Professor (Simple Pixel Art Representation)
        const px = this.prof.x;
        const py = this.prof.y + Math.sin(Date.now() / 500) * 5; // Idle animation
        
        // Head
        ctx.fillStyle = '#ffccaa';
        ctx.fillRect(px - 20, py, 40, 40);
        // Beard
        ctx.fillStyle = '#fff';
        ctx.fillRect(px - 20, py + 30, 40, 20);
        // Body
        ctx.fillStyle = '#333';
        ctx.fillRect(px - 25, py + 50, 50, 60);
        // Pointer stick
        ctx.strokeStyle = '#a67c52';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(px + 20, py + 70);
        ctx.lineTo(px + 60, py + 40);
        ctx.stroke();

        // 4. Desks & Students
        this.students.forEach((s, idx) => {
            const sx = s.x;
            const sy = s.y;
            
            // Desk
            ctx.fillStyle = '#8d6e63';
            ctx.fillRect(sx - 50, sy, 100, 60);
            
            // Student
            // If this student is speaking, bounce them
            const isSpeaking = document.getElementById('dialogue-name').innerText === s.name;
            const bounce = isSpeaking ? Math.abs(Math.sin(Date.now()/100) * 10) : 0;

            ctx.fillStyle = s.color; // Shirt
            ctx.fillRect(sx - 20, sy - 40 - bounce, 40, 40);
            ctx.fillStyle = '#ffccaa'; // Head
            ctx.fillRect(sx - 15, sy - 70 - bounce, 30, 30);
            
            // Name tag
            ctx.fillStyle = '#000';
            ctx.font = '16px VT323';
            ctx.textAlign = 'center';
            ctx.fillText(s.name, sx, sy + 80);
        });
    }
};

</script>
</body>
</html>
